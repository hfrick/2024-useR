{
  "hash": "aeb313eed51385f191a05394fd1908a3",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"tidymodels - Now also for time-to-event data!\"\nsubtitle: \"useR 2024\"\nauthor: \"Hannah Frick\"\nformat:\n  revealjs: \n    slide-number: true\n    show-slide-number: all\n    footer: <https://hfrick.github.io/2024-useR>\n    theme: [default, style.scss]\n    css: styles.css\n    highlight-style: a11y\n    width: 1280\n    height: 720\nknitr:\n  opts_chunk: \n    echo: true\n    collapse: true\n    comment: \"#>\"\n---\n\n::: {.cell}\n\n:::\n\n\n\n# Why tidymodels?\n\n---\n\n<br><br><br>\n\n::: {.r-fit-text}\ntidymodels is a framework for modelling and \n\nmachine learning using tidyverse principles.\n:::\n\n\n## Core coverage\n\n. . .\n\n<!-- left to right, one right next to each other: increase \"left\" by 150 -- which is the width of the image -->\n\n![](images/hex/rsample.png){.absolute top=\"200\" left=\"50\" width=\"150\"} \n\n. . .\n\n![](images/hex/recipes.png){.absolute top=\"200\" left=\"300\" width=\"150\"} \n\n. . .\n\n![](images/hex/parsnip.png){.absolute top=\"200\" left=\"550\" width=\"150\"} \n\n. . .\n\n![](images/hex/yardstick.png){.absolute top=\"200\" left=\"800\" width=\"150\"} \n\n. . .\n\n![](images/hex/tune.png){.absolute top=\"200\" left=\"1050\" width=\"150\"} \n\n\n\n## Extendable\n\n![](images/hex/rsample.png){.absolute top=\"200\" left=\"50\" width=\"150\"} \n![](images/hex/recipes.png){.absolute top=\"200\" left=\"300\" width=\"150\"} \n![](images/hex/parsnip.png){.absolute top=\"200\" left=\"550\" width=\"150\"} \n![](images/hex/yardstick.png){.absolute top=\"200\" left=\"800\" width=\"150\"} \n![](images/hex/tune.png){.absolute top=\"200\" left=\"1050\" width=\"150\"} \n\n. . .\n\n<!-- + 133 down and + 76 to the left -->\n![](images/hex/spatialsample.png){.absolute top=\"333\" left=\"126\" width=\"150\"} \n\n. . .\n\n![](images/hex/waywiser.png){.absolute top=\"333\" left=\"876\" width=\"150\"} \n\n. . .\n\n![](images/hex/finetune.png){.absolute top=\"333\" left=\"1126\" width=\"150\"} \n\n. . .\n\n![](images/hex/textrecipes.png){.absolute top=\"333\" left=\"376\" width=\"150\"} \n![](images/hex/embed.png){.absolute top=\"466\" left=\"452\" width=\"150\"} \n![](images/hex/themis.png){.absolute top=\"67\" left=\"224\" width=\"150\"} \n\n. . .\n\n![](images/hex/agua.svg){.absolute top=\"-66\" left=\"398\" width=\"150\"} \n![](images/hex/bonsai.png){.absolute top=\"-66\" left=\"550\" width=\"150\"} \n![](images/hex/poissonreg.png){.absolute top=\"-66\" left=\"702\" width=\"150\"} \n![](images/hex/rules.png){.absolute top=\"67\" left=\"474\" width=\"150\"} \n![](images/hex/multilevelmod.png){.absolute top=\"67\" left=\"626\" width=\"150\"} \n![](images/hex/censored.png){.absolute top=\"333\" left=\"626\" width=\"150\"} \n![](images/hex/baguette.png){.absolute top=\"466\" left=\"702\" width=\"150\"} \n![](images/hex/discrim.png){.absolute top=\"599\" left=\"778\" width=\"150\"} \n\n\n\n## {background-iframe=\"https://www.tidymodels.org/learn/#category=developer%20tools\"}\n\n::: footer\n:::\n\n\n\n\n\n\n---\n\n<br><br><br>\n\n::: {.r-fit-text}\nFocus on the modelling question,  \n\n  not the infrastructure for  \n  empirical validation.\n:::\n\n---\n\n<br><br><br>\n\n::: {.r-fit-text}\nFocus on the modelling question,  \n\n  not the syntax.\n:::\n\n::: {.notes}\n- unify: switch easily between models\n- consistency: \n- composable functions support chunking\n  - object (a recipe) to hold all preprocessing, apply it in various places\n:::\n\n\n\n# Why survival analysis?\n\n## Customer churn\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwa_churn\n```\n:::\n\n::: {.cell}\n\n```\n#> # A tibble: 7,032 × 18\n#>   tenure churn female senior_citizen partner dependents phone_service\n#>    <int> <fct>  <dbl>          <int>   <dbl>      <dbl>         <dbl>\n#> 1      1 No         1              0       1          0             0\n#> 2     34 No         0              0       0          0             1\n#> 3      2 Yes        0              0       0          0             1\n#> 4     45 No         0              0       0          0             0\n#> 5      2 Yes        1              0       0          0             1\n#> 6      8 Yes        1              0       0          0             1\n#> # ℹ 7,026 more rows\n#> # ℹ 11 more variables: multiple_lines <chr>, internet_service <fct>,\n#> #   online_security <chr>, online_backup <chr>,\n#> #   device_protection <chr>, tech_support <chr>, streaming_tv <chr>,\n#> #   streaming_movies <chr>, paperless_billing <dbl>,\n#> #   payment_method <fct>, monthly_charges <dbl>\n```\n:::\n\n\n\n## What might you want to model with these data?\n\nLet's try to predict:\n\n. . .\n\n- How long is somebody going to stay as a customer?\n\n. . .\n\n- Who is likely to stop being a customer?\n\n\n<!-- Everything is a nail when you only have a hammer. -->\n\n# How long is somebody going to stay as a customer?\n\n\n## What if we just use the time?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/df_illustration-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n. . . \n\nThat time is **observation time**, not **time to event**.\n\n## What if we just use the time?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-3-1.png){fig-align='center' width=960}\n:::\n:::\n\n\nIf we assume that's time-to-event, **we assume everything is an event**.\n\n## What we actually have\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-4-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n::: {.notes}\n- using censored obs as events underestimates the survival time\n- discarding censored obs also biases the results\n- wait until we observe everything? not always possible (dropout of study)\n:::\n\n## Uncomfy\n\nIf we use regression to model time-to-event data, we might\n\n- answer a different question\n- make wrong assumptions\n- waste information\n\n\n\n# Who is likely to stop being a customer?\n\n## What if we just use the event status?\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-revealjs/unnamed-chunk-5-1.png){fig-align='center' width=960}\n:::\n:::\n\n\n. . .\n\nWho is likely to stop being a customer _while we observe them?_\n\n<!-- --- -->\n\n\n::: {.cell layout-align=\"center\"}\n\n:::\n\n\n<!-- \n\n---\n\nFIXME: add translation of this idea to Kaplan-Meier?\n-->\n\n\n## Uncomfy\n\n<br><br>\n\nIf we use classification to model (time-to-)event data, we  \n\nignore the (possibly wildly) different observation length.\n\n\n## Our challenge\n\n- Time-to-event data inherently has two aspects: time and event status.\n- Censoring: incomplete data is not missing data.\n\n. . .\n\n- _With regression and classification we can only model one aspect, separately, without being able to properly account for the other aspect._\n\n---\n\n\n<br><br>\n\n> Survival analysis is unique because it simultaneously considers _if_ events happened (i.e. a binary outcome) and _when_ events happened (e.g. a continuous outcome).[^1]\n\n[^1]: Denfeld QE, Burger D, Lee CS (2023) _Survival analysis 101: an easy start guide to analysing time-to-event data_. European Journal of Cardiovascular Nursing, Volume 22, Issue 3, Pages 332–337, <https://doi.org/10.1093/eurjcn/zvad023>\n\n## \n\n![](images/how-to-draw-an-owl.jpeg){fig-align=\"center\"}\n\n\n## Customer churn\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntelco_churn <- wa_churn %>% \n  mutate(\n    churn_surv = Surv(tenure, if_else(churn == \"Yes\", 1, 0)),\n    .keep = \"unused\"\n  )\n```\n:::\n\n\n::: {.notes}\n- Surv = response\n- modify response outside of recipes\n:::\n\n## Split the data\n\n\n::: {.cell}\n\n```{.r .cell-code  code-line-numbers=\"1-2|4-5\"}\nset.seed(403)\ntelco_split <- initial_split(telco_churn)\n\ntelco_train <- training(telco_split)\ntelco_test <- testing(telco_split)\n```\n:::\n\n\n## A single model\n\n\n::: {.cell}\n\n```{.r .cell-code  code-line-numbers=\"1-2|4-6|8-10|12\"}\ntelco_rec <- recipe(churn_surv ~ ., data = telco_train) %>% \n  step_zv(all_predictors()) \n\ntelco_spec <- survival_reg() %>%\n  set_mode(\"censored regression\") %>%\n  set_engine(\"survival\")\n\ntelco_wflow <- workflow() %>%\n  add_recipe(telco_rec) %>%\n  add_model(telco_spec)\n\ntelco_fit <- fit(telco_wflow, data = telco_train)\n```\n:::\n\n\n## How long is somebody going to stay as a customer?\n\n\n::: {.cell}\n\n```{.r .cell-code}\npredict(telco_fit, new_data = telco_train[1:5, ], type = \"time\")\n#> # A tibble: 5 × 1\n#>   .pred_time\n#>        <dbl>\n#> 1     262.  \n#> 2     113.  \n#> 3      43.6 \n#> 4       6.55\n#> 5     130.\n```\n:::\n\n\n## Who is likely to stop being a customer?\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_survival <- predict(telco_fit, new_data = telco_train[1:5, ], \n                         type = \"survival\", eval_time = c(12, 24))\n\npred_survival\n#> # A tibble: 5 × 1\n#>   .pred           \n#>   <list>          \n#> 1 <tibble [2 × 2]>\n#> 2 <tibble [2 × 2]>\n#> 3 <tibble [2 × 2]>\n#> 4 <tibble [2 × 2]>\n#> 5 <tibble [2 × 2]>\n```\n:::\n\n\n## Who is likely to stop being a customer?\n\n\n::: {.cell}\n\n```{.r .cell-code}\npred_survival$.pred[[1]]\n#> # A tibble: 2 × 2\n#>   .eval_time .pred_survival\n#>        <dbl>          <dbl>\n#> 1         12          0.931\n#> 2         24          0.878\n```\n:::\n\n\n<!-- \n- show survival curves?\n- predict censored observations only and filter for their individual eval_time == observed_time?\n-->\n\n## tidymodels for survival analysis\n\n- [Models](https://censored.tidymodels.org/#available-models-engines-and-prediction-types):  \n  parametric, semi-parametric, and tree-based\n- [Predictions](https://censored.tidymodels.org/#available-models-engines-and-prediction-types):  \n  survival time, survival probability, hazard, and linear predictor\n- [Metrics](https://yardstick.tidymodels.org/reference/index.html#dynamic-survival-metrics):  \n  concordance index, Brier score, integrated Brier score, AUC ROC\n\n## tidymodels for survival analysis\n\n<br>\n\n![](images/hex/tidymodels.png){fig-align=\"center\" height=\"400\"}\n\n## Learn more on [tidymodels.org](https://www.tidymodels.org/)\n\n- [How long until building complaints are dispositioned? A survival analysis case study](https://www.tidymodels.org/learn/statistics/survival-case-study/)\n- [Dynamic Performance Metrics for Event Time Data](https://www.tidymodels.org/learn/statistics/survival-metrics/)\n- [Accounting for Censoring in Performance Metrics for Event Time Data](https://www.tidymodels.org/learn/statistics/survival-metrics-details/)\n\n\n# {background-color=\"#CA225E\"}\n<center>\n[tidymodels.org]{style=\"font-size:2.5em;\"}\n</center>",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}